# transformHtmlCode

A rehype plugin that transforms `<pre>` elements containing `<code>` blocks into precomputed data for the CodeHighlighter component. This plugin extracts source code from HTML, processes it through syntax highlighting and transformations, then stores the results for efficient client-side rendering.

## Overview

This plugin is typically used in the **second stage** of a markdown-to-HTML processing pipeline, after [`transformMarkdownCodeVariants`](/functions/transformMarkdownCodeVariants) has converted markdown code blocks into HTML structures.

## Key Features

- **Multiple code variants**: Process multiple languages or versions within a single code block
- **Automatic language detection**: Determines file types from `class="language-*"` attributes
- **Custom variant names**: Supports `data-variant` attribute for explicit naming
- **Custom filenames**: Supports `data-filename` attribute for specific file extensions
- **Opt-in transformations**: Code blocks are only transformed when marked with `data-transform="true"`
- **Built-in transformations**: Includes TypeScript-to-JavaScript conversion for marked blocks
- **Syntax highlighting**: Pre-processes code for faster client rendering
- **Error handling**: Gracefully handles processing errors

## Installation & Usage

```typescript
import { unified } from 'unified';
import rehypeParse from 'rehype-parse';
import { transformHtmlCode } from '@mui/internal-docs-infra/pipeline/transformHtmlCode';

const processor = unified()
  .use(rehypeParse)
  .use(transformHtmlCode) // No configuration needed
  .use(rehypeStringify);
```

### With Next.js and MDX

```javascript
// next.config.js
const withMDX = require('@next/mdx')({
  options: {
    remarkPlugins: [transformMarkdownCodeVariants],
    rehypePlugins: [transformHtmlCode],
  },
});

module.exports = withMDX({
  // your Next.js config
});
```

## Input Examples

### Single Code Block

```html
<pre><code class="language-typescript">
const greeting: string = "Hello, world!";
console.log(greeting);
</code></pre>
```

### Multiple Code Variants (Different Languages)

```html
<pre>
  <code class="language-js">console.log("Hello, world!");</code>
  <code class="language-ts">console.log("Hello, world!" as string);</code>
</pre>
```

### Custom Variant Names

```html
<pre>
  <code class="language-js" data-variant="Client">console.log("Running on client");</code>
  <code class="language-js" data-variant="Server">console.log("Running on server");</code>
</pre>
```

### Custom Filenames

```html
<pre><code class="language-js" data-filename="app.jsx">
const App = () => <div>Hello React!</div>;
export default App;
</code></pre>
```

### Code Block Transformations

By default, code blocks are processed for syntax highlighting only. To enable transformations (like TypeScript-to-JavaScript conversion), explicitly mark the code block:

```html
<pre><code class="language-ts" data-transform="true">
const greeting: string = "Hello, world!";
console.log(greeting);
</code></pre>
```

This will generate both the original TypeScript and the transformed JavaScript versions.

## Output

After processing, the plugin:

1. **Replaces content** with a placeholder message
2. **Stores processed data** in `dataPrecompute` attribute as JSON
3. **Preserves original structure** for the CodeHighlighter component

```html
<pre data-precompute='{"Default":{"fileName":"index.ts","source":"...","transforms":{...}}}'>
  Error: expected pre tag to be handled by CodeHighlighter
</pre>
```

## Variant Naming

| Scenario              | Variant Names                      |
| --------------------- | ---------------------------------- |
| Single code block     | `"Default"`                        |
| Different languages   | `"Js"`, `"Ts"`, `"Html"`, etc.     |
| Same language         | `"Variant 1"`, `"Variant 2"`, etc. |
| Custom `data-variant` | Uses the specified name            |

## Supported Languages

| Class                                | Extension | Notes                                                 |
| ------------------------------------ | --------- | ----------------------------------------------------- |
| `language-js`, `language-javascript` | `.js`     |                                                       |
| `language-ts`, `language-typescript` | `.ts`     | Includes TSâ†’JS transform when `data-transform="true"` |
| `language-tsx`                       | `.tsx`    | React TypeScript                                      |
| `language-jsx`                       | `.jsx`    | React JavaScript                                      |
| `language-json`                      | `.json`   |                                                       |
| `language-html`                      | `.html`   |                                                       |
| `language-css`                       | `.css`    |                                                       |
| `language-bash`, `language-shell`    | `.sh`     |                                                       |
| `language-yaml`, `language-yml`      | `.yaml`   |                                                       |
| Others                               | `.txt`    | Fallback                                              |

## Integration with transformMarkdownCodeVariants

These plugins work together in a processing pipeline:

1. **transformMarkdownCodeVariants** (remark): Converts markdown code blocks with variants into HTML
2. **transformHtmlCode** (rehype): Processes the HTML and precomputes data for rendering

### Complete Example

**Markdown Input:**

````markdown
npm

```bash variant-group=install
npm install package
```

pnpm

```bash variant-group=install
pnpm install package
```
````

**After transformMarkdownCodeVariants:**

```html
<pre>
  <code class="language-bash" data-variant="npm">npm install package</code>
  <code class="language-bash" data-variant="pnpm">pnpm install package</code>
</pre>
```

**After transformHtmlCode:**

```html
<pre data-precompute='{"npm":{"fileName":"index.sh","source":"npm install package"...}}'>
  Error: expected pre tag to be handled by CodeHighlighter
</pre>
```

- Processes code blocks in parallel across the document
- Optimized text extraction with single-pass traversal

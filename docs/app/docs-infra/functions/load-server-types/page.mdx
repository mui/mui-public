# Load Server Types

A server-side function for loading and processing TypeScript types with syntax highlighting. This function coordinates the type extraction pipeline and applies HAST transformations for rendering.

---

## Overview

`loadServerTypes` is the primary server-side entry point for type documentation processing. It:

1. Calls [`syncTypes`](../sync-types/page.mdx) to extract and format TypeScript types
2. Applies syntax highlighting via `highlightTypes` for HAST output

This separation allows for different rendering strategies (e.g., server-side vs client-side highlighting) and keeps the core type extraction logic reusable.

---

## Usage

### Basic Usage

```typescript
import { loadServerTypes } from '@mui/internal-docs-infra/pipeline/loadServerTypes';
import { parseCreateFactoryCall } from '@mui/internal-docs-infra/pipeline/loadPrecomputedCodeHighlighter/parseCreateFactoryCall';

// Parse a types.ts file to get the factory call info
const source = await fs.readFile('path/to/types.ts', 'utf-8');
const typesMetaCall = await parseCreateFactoryCall(source, 'path/to/types.ts', {
  allowExternalVariants: true,
});

// Load and process types with highlighting
const result = await loadServerTypes({
  resourcePath: '/absolute/path/to/types.ts',
  resourceName: 'Button',
  rootContext: '/absolute/path/to/project',
  relativePath: 'app/components/button/types.ts',
  typesMetaCall,
  formattingOptions: {
    shortTypeUnionPrintWidth: 40,
    defaultValueUnionPrintWidth: 40,
  },
});

// Use the results
console.log(result.highlightedVariantData); // Ready for precompute injection
console.log(result.allTypes); // TypesMeta[]
console.log(result.allDependencies); // string[] - files to watch
```

### With Custom Socket Directory

```typescript
const result = await loadServerTypes({
  resourcePath: '/absolute/path/to/types.ts',
  resourceName: 'Button',
  rootContext: '/absolute/path/to/project',
  relativePath: 'app/components/button/types.ts',
  typesMetaCall,
  socketDir: '/tmp/my-custom-socket-dir', // For Windows compatibility
  performanceLogging: true,
});
```

---

## Options

`LoadServerTypesOptions` extends [`SyncTypesOptions`](../sync-types/page.mdx):

```typescript
interface LoadServerTypesOptions extends SyncTypesOptions {}

interface SyncTypesOptions {
  /** Absolute path to the resource being processed */
  resourcePath: string;

  /** Name of the resource (for display purposes) */
  resourceName: string;

  /** Root context directory (workspace root) */
  rootContext: string;

  /** Relative path from rootContext to resourcePath */
  relativePath: string;

  /** Parsed createTypesMeta call information */
  typesMetaCall: ParsedCreateFactory;

  /** Options for formatting types in tables */
  formattingOptions?: FormatInlineTypeOptions;

  /**
   * Directory path for socket and lock files used for IPC between workers.
   * Useful for Windows where the default temp directory may not support Unix domain sockets.
   */
  socketDir?: string;

  /** Enable performance logging */
  performanceLogging?: boolean;
}
```

---

## Result

```typescript
interface LoadServerTypesResult {
  /** Highlighted variant data ready for precompute injection */
  highlightedVariantData: Record<
    string,
    { types: TypesMeta[]; typeNameMap?: Record<string, string> }
  >;

  /** All dependencies that should be watched for changes */
  allDependencies: string[];

  /** All processed types for external use */
  allTypes: TypesMeta[];

  /** Type name map from variant processing */
  typeNameMap?: Record<string, string>;
}
```

---

## Processing Pipeline

### 1. Call syncTypes

Delegates to [`syncTypes`](../sync-types/page.mdx) for core type processing:

- Loads TypeScript configuration
- Resolves library source files
- Finds meta files (DataAttributes, CssVars)
- Processes types via worker thread
- Formats component and hook types
- **Updates `types.md`** with the latest documentation

### 2. Apply Syntax Highlighting

Transforms all HAST nodes with precomputed syntax highlighting:

```typescript
const highlightedVariantData = await highlightTypes(syncResult.variantData);
```

The `highlightTypes` function processes:

- Component and hook descriptions (markdown with code blocks)
- Prop/parameter examples (markdown with code blocks)
- Prop/parameter descriptions (markdown with code blocks)
- Data attribute and CSS variable descriptions (markdown with code blocks)

> **Note**: Type strings (`type`, `shortType`, `detailedType`, `default`) are already syntax-highlighted inline during formatting in `syncTypes`, so they don't need processing here.

---

## When to Use

### Use `loadServerTypes` when:

- Building type documentation with syntax highlighting
- Creating precomputed type data for webpack loaders
- Processing types in API routes or custom build tools

### Use `syncTypes` directly when:

- You need raw type data without highlighting
- You want to apply custom highlighting or transformations
- You're integrating with a different rendering pipeline

---

## Performance

The function inherits performance characteristics from `syncTypes`:

### First Request

~500-1200ms to create TypeScript program and parse types

### Subsequent Requests

~100-140ms using cached program and file data

### Highlighting Overhead

Typically adds 10-50ms depending on the amount of markdown content with code blocks.

---

## Related

- [`syncTypes`](../sync-types/page.mdx) - Core type synchronization (called internally)
- [`loadPrecomputedTypesMeta`](../load-precomputed-types-meta/page.mdx) - Webpack loader that uses this function
- [`abstractCreateTypes`](../abstract-create-types/page.mdx) - Create type documentation factories

---

## Types

import { TypesLoadServerTypes } from './types';

<TypesLoadServerTypes />

[See Types](./types.md#loadservertypes)

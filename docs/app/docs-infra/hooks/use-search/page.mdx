# useSearch

The `useSearch` hook provides a powerful client-side search engine using [Orama](https://github.com/oramasearch/orama) for documentation sites. It handles index creation, search queries, and result formatting with built-in support for TypeScript-to-JavaScript transformations, stemming, and customizable result types.

---

## Overview

`useSearch` creates an in-memory search index from your sitemap data and provides instant search results with fuzzy matching, boosting, and tolerance controls. It's designed to work seamlessly with documentation structures that include pages, sections, subsections, component parts, and exports.

### Key Features

- **Fast in-memory search** with Orama's optimized indexing
- **Automatic stemming** and stop word filtering for English
- **Fuzzy matching** with configurable tolerance
- **Result boosting** by field or result type
- **Multiple result types** including pages, sections, parts, and exports
- **Default results** for empty search states
- **URL generation** with hash fragment support
- **Type-safe** with full TypeScript support

---

## Basic Usage

```tsx
import { useSearch } from '@mui/internal-docs-infra/useSearch';

function SearchComponent() {
  const { results, search, isReady, defaultResults, buildResultUrl } = useSearch({
    sitemap: () => import('./sitemap'),
    maxDefaultResults: 10,
    enableStemming: true,
  });

  const handleSearch = (query: string) => {
    search(query);
  };

  return (
    <div>
      <input onChange={(e) => handleSearch(e.target.value)} />
      {results.map((result) => (
        <a key={result.id} href={buildResultUrl(result)}>
          {result.title}
        </a>
      ))}
    </div>
  );
}
```

---

## Sitemap Structure

The hook expects a sitemap that follows this structure:

```typescript
interface Sitemap {
  schema: Record<string, any>;
  data: Record<string, SitemapSectionData>;
}

interface SitemapSectionData {
  title: string;
  prefix: string;
  pages: SitemapPage[];
}

interface SitemapPage {
  title: string;
  slug: string;
  path: string;
  description: string;
  keywords?: string[];
  sections?: Record<string, SitemapSection>;
  parts?: Record<string, SitemapPart>;
  exports?: Record<string, SitemapExport>;
}
```

---

## Configuration

### Stemming and Stop Words

Enable stemming to improve search quality by reducing words to their root form:

```tsx
const { search } = useSearch({
  sitemap: () => import('./sitemap'),
  enableStemming: true, // Default: true
});
```

When enabled, searches for "running" will also match "run", "runs", and "runner".

### Fuzzy Matching

Control how tolerant the search is to typos:

```tsx
const { search } = useSearch({
  sitemap: () => import('./sitemap'),
  tolerance: 2, // Default: 1
});
```

Higher tolerance values allow more character differences between the query and results.

### Result Limiting

Configure how many results to return:

```tsx
const { search, defaultResults } = useSearch({
  sitemap: () => import('./sitemap'),
  maxDefaultResults: 10, // Default: 10
  limit: 20, // Default: 20
});
```

### Field Boosting

Boost specific fields to prioritize certain result types:

```tsx
const { search } = useSearch({
  sitemap: () => import('./sitemap'),
  boost: {
    type: 3,
    title: 2,
    slug: 2,
    section: 2,
    export: 1.5,
    part: 1.5,
    description: 1.3,
  },
});
```

---

## Result Types

The hook returns results with a discriminated union type:

```typescript
type SearchResult =
  | PageSearchResult
  | PartSearchResult
  | ExportSearchResult
  | SectionSearchResult
  | SubsectionSearchResult;
```

### Page Result

Top-level documentation pages:

```typescript
interface PageSearchResult {
  type: 'page';
  title: string;
  description: string;
  slug: string;
  path: string;
  sectionTitle: string;
  prefix: string;
  sections?: string;
  subsections?: string;
  keywords?: string;
  score?: number;
}
```

### Section Result

Top-level headings within a page:

```typescript
interface SectionSearchResult {
  type: 'section';
  section: string;
  // ... base fields
}
```

### Subsection Result

Nested headings within a page:

```typescript
interface SubsectionSearchResult {
  type: 'subsection';
  subsection: string;
  // ... base fields
}
```

### Part Result

Component parts with API documentation:

```typescript
interface PartSearchResult {
  type: 'part';
  part: string;
  export: string;
  props?: string;
  dataAttributes?: string;
  cssVariables?: string;
  // ... base fields
}
```

### Export Result

Exported functions/components with API documentation:

```typescript
interface ExportSearchResult {
  type: 'export';
  export: string;
  props?: string;
  dataAttributes?: string;
  cssVariables?: string;
  // ... base fields
}
```

---

## Custom Processing

### Custom Flattening

Override how pages are converted to search entries:

```tsx
const { search } = useSearch({
  sitemap: () => import('./sitemap'),
  flattenPage: (page, sectionData) => {
    return [
      {
        type: 'page',
        title: page.title,
        slug: page.slug,
        path: page.path,
        description: page.description,
        sectionTitle: sectionData.title,
        prefix: sectionData.prefix,
      },
    ];
  },
});
```

### Custom Formatting

Override how search hits are formatted:

```tsx
const { search } = useSearch({
  sitemap: () => import('./sitemap'),
  formatResult: (hit) => {
    return {
      type: 'page',
      id: hit.id,
      title: hit.document.title.toUpperCase(),
      description: hit.document.description,
      slug: hit.document.slug,
      path: hit.document.path,
      sectionTitle: hit.document.sectionTitle,
      prefix: hit.document.prefix,
      score: hit.score,
    };
  },
});
```

---

## Return Value

### `results`

Array of current search results, or default results if no search has been performed:

```typescript
results: SearchResult[];
```

### `isReady`

Boolean indicating whether the search index has been created and is ready:

```typescript
isReady: boolean;
```

### `search`

Function to perform a search query:

```typescript
search: (value: string) => Promise<void>;
```

### `defaultResults`

Array of default results shown when search is empty:

```typescript
defaultResults: SearchResult[];
```

### `buildResultUrl`

Function to build URLs from search results with proper hash fragments:

```typescript
buildResultUrl: (result: SearchResult) => string;
```

---

## URL Building

The `buildResultUrl` function handles different result types:

- **Page results**: Returns the page path
- **Section results**: Adds `#section-slug` to the page path
- **Subsection results**: Adds `#subsection-slug` to the page path
- **Part results**: Adds `#part-name` to the page path
- **Export results**: Adds `#export-name` or `#api-reference` to the page path

Example output:

```typescript
// Page result
buildResultUrl(pageResult); // "/components/button"

// Section result
buildResultUrl(sectionResult); // "/components/button#usage"

// Export result
buildResultUrl(exportResult); // "/components/button#api-reference"
```

---

## Performance

The search index is built asynchronously when the component mounts. Use the `isReady` flag to show loading states:

```tsx
const { isReady, search, results } = useSearch({
  sitemap: () => import('./sitemap'),
});

if (!isReady) {
  return <div>Loading search index...</div>;
}
```

Index creation is fast but happens only once per mount. Consider memoizing the sitemap import for optimal performance.

---

## Best Practices

1. **Enable stemming** for better search quality in English documentation
2. **Use default results** to show popular pages when the search is empty
3. **Boost important fields** like `type`, `title`, and `slug` to prioritize exact matches
4. **Set appropriate tolerance** based on your use case (1-2 for strict, 3+ for lenient)
5. **Limit results** to keep the UI manageable (10-20 results is typical)
6. **Use `buildResultUrl`** to ensure consistent URL formatting across result types
7. **Check `isReady`** before allowing searches to prevent errors

---

## Type Definitions

```typescript
interface UseSearchOptions {
  /** Function that returns a promise resolving to sitemap data */
  sitemap: () => Promise<{ sitemap?: Sitemap }>;
  /** Maximum number of default results to show */
  maxDefaultResults?: number;
  /** Search tolerance for fuzzy matching */
  tolerance?: number;
  /** Maximum number of search results */
  limit?: number;
  /** Enable stemming and stopwords (uses English by default) */
  enableStemming?: boolean;
  /** Boost values for different result types and fields */
  boost?: Partial<Record<string, number>>;
  /** Custom function to flatten sitemap pages into search results */
  flattenPage?: (page: SitemapPage, sectionData: SitemapSectionData) => SearchResult[];
  /** Custom function to format Orama search hits into typed results */
  formatResult?: <TDocument = any>(hit: Result<TDocument>) => SearchResult;
}

interface UseSearchResult {
  /** Current search results */
  results: SearchResult[];
  /** Whether the search index is ready */
  isReady: boolean;
  /** Function to update search value and get new results */
  search: (value: string) => Promise<void>;
  /** Default results shown when search is empty */
  defaultResults: SearchResult[];
  /** Build a URL from a search result */
  buildResultUrl: (result: SearchResult) => string;
}
```

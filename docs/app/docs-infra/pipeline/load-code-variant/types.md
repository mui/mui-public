# Load Code Variant

[//]: types.ts '<-- Autogenerated By (do not edit the following markdown directly), run: pnpm docs:validate docs-infra/pipeline/load-code-variant'

## API Reference

### addPathsToVariant

Add flat paths to all files in a variant

**Parameters:**

| Parameter | Type          | Default | Description |
| :-------- | :------------ | :------ | :---------- |
| variant   | `VariantCode` | -       | -           |

**Return Value:**

```tsx
type ReturnValue = VariantCode;
```

### applyCodeTransform

Applies a specific transform to a variant source and returns the transformed source

**Parameters:**

| Parameter    | Type            | Default | Description                                                         |
| :----------- | :-------------- | :------ | :------------------------------------------------------------------ |
| source       | `VariantSource` | -       | The original variant source (string, HastNodes, or hastJson object) |
| transforms   | `Transforms`    | -       | Object containing all available transforms                          |
| transformKey | `string`        | -       | The key of the specific transform to apply                          |

**Return Value:**

The transformed variant source in the same format as the input

```tsx
type ReturnValue = VariantSource;
```

### applyCodeTransforms

Applies multiple transforms to a variant source in sequence

**Parameters:**

| Parameter     | Type            | Default | Description                                |
| :------------ | :-------------- | :------ | :----------------------------------------- |
| source        | `VariantSource` | -       | The original variant source                |
| transforms    | `Transforms`    | -       | Object containing all available transforms |
| transformKeys | `string[]`      | -       | Array of transform keys to apply in order  |

**Return Value:**

The transformed variant source in the same format as the input

```tsx
type ReturnValue = VariantSource;
```

### enhanceCode

Async function to enhance parsed code variants and their extraFiles.
Applies sourceEnhancers to HAST nodes, using comments stored in the variant.

**Parameters:**

| Parameter       | Type               | Default | Description |
| :-------------- | :----------------- | :------ | :---------- |
| code            | `Code`             | -       | -           |
| sourceEnhancers | `SourceEnhancer[]` | -       | -           |

**Return Value:**

```tsx
type ReturnValue = Promise<Code>;
```

### examineCodeVariant

Create path context for processing files with extended information

**Parameters:**

| Parameter | Type          | Default | Description |
| :-------- | :------------ | :------ | :---------- |
| variant   | `VariantCode` | -       | -           |

**Return Value:**

```tsx
type ReturnValue = PathContext;
```

### extractCodeMetadata

Extract metadata files from a variant, scoping them according to metadataPrefix

**Parameters:**

| Parameter | Type          | Default | Description                                            |
| :-------- | :------------ | :------ | :----------------------------------------------------- |
| variant   | `VariantCode` | -       | The variant containing mixed source and metadata files |

**Return Value:**

An object with the cleaned variant and extracted metadata

| Property   | Type                | Description |
| :--------- | :------------------ | :---------- |
| `variant`  | `VariantCode`       | -           |
| `metadata` | `VariantExtraFiles` | -           |

### flattenCodeVariant

Flatten a VariantCode into a flat files structure
Resolves relative paths and handles metadata file scoping
Uses addPathsToVariant for path resolution logic

**Parameters:**

| Parameter | Type          | Default | Description |
| :-------- | :------------ | :------ | :---------- |
| variant   | `VariantCode` | -       | -           |

**Return Value:**

```tsx
type ReturnValue = FlattenedFiles;
```

### hasAllVariants

Determines if all code variants are fully loaded and ready to render the complete content component.

This function validates that we have all necessary data to transition from fallback/loading state
to the full interactive code highlighter. It checks both main files and extra files for all variants.

Used primarily to determine when to show the full Content component instead of ContentLoading
fallback, ensuring a smooth user experience without rendering errors.

**Parameters:**

| Parameter       | Type       | Default | Description                                                                         |
| :-------------- | :--------- | :------ | :---------------------------------------------------------------------------------- |
| variants        | `string[]` | -       | Array of variant names that must all be ready (e.g., \['javascript', 'typescript']) |
| code            | `Code`     | -       | The code object containing variant data                                             |
| needsHighlight? | `boolean`  | -       | Whether all sources need to be syntax highlighted (hast nodes, not strings)         |

**Return Value:**

True if all variants and their files are loaded and ready for full rendering

```tsx
type ReturnValue = boolean;
```

### loadCodeFallback

Loads minimal data needed for fallback rendering.
Returns code, initial filename, initial source, extra files, all file names,
and processed globals code.

**Parameters:**

| Parameter      | Type                      | Default | Description                           |
| :------------- | :------------------------ | :------ | :------------------------------------ |
| url            | `string`                  | -       | File URL for the variant              |
| initialVariant | `string`                  | -       | Name of the initial variant to load   |
| loaded         | `Code \| undefined`       | -       | Previously loaded Code object, if any |
| options?       | `LoadFallbackCodeOptions` | -       | Optional loading configuration        |

**Return Value:**

```tsx
type ReturnValue = Promise<FallbackVariants>;
```

### loadCodeVariant

Loads a variant with support for recursive extra file loading.
The loadSource function can now return extraFiles that will be loaded recursively.
Supports both relative and absolute paths for extra files.
Uses Promise.all for efficient parallel loading of extra files.

**Parameters:**

| Parameter   | Type                                 | Default | Description                                                                   |
| :---------- | :----------------------------------- | :------ | :---------------------------------------------------------------------------- |
| url         | `string \| undefined`                | -       | File URL for the variant                                                      |
| variantName | `string`                             | -       | Name of the variant (used for error messages)                                 |
| variant     | `VariantCode \| string \| undefined` | -       | Variant data object or URL string                                             |
| options?    | `LoadVariantOptions`                 | -       | Loading and processing options (source parser, transformers, enhancers, etc.) |

**Return Value:**

```tsx
type ReturnValue = Promise<{ code: VariantCode; dependencies: string[]; externals: Externals }>;
```

### maybeCodeInitialData

Type guard function that determines if we have sufficient data to render a code highlighter
component immediately, or if we need to start loading data first.

This function acts as a validation layer to ensure we have the minimal required data
to render either a fallback state or the actual code content, helping to prevent
rendering errors and provide better user experience.

## Usage Contexts

This function is used in two main scenarios:

1. **Server-side rendering (CodeHighlighter)**: Determines if we can render with initial
   source content immediately, or if we need to load fallback data via `CodeInitialSourceLoader`

2. **Client-side hydration (CodeHighlighterClient)**: Within `useInitialData` hook to determine
   if we should trigger loading effects or if we can render with available data

## Decision Flow

The function checks data availability in this order:

1. Code object exists and contains the requested variant
2. All required variants are available (if `needsAllVariants` is true)
3. Requested file exists (main file or in extraFiles)
4. All extra files are loaded (if `needsAllFiles` is true)
5. Source content is properly highlighted (if `needsHighlight` is true)

## Synchronous vs Asynchronous Behavior

This function operates **synchronously** and only validates existing data - it never triggers
any loading operations. This design is crucial for performance and rendering strategies:

- **Synchronous validation** allows immediate decisions about rendering paths without async overhead
- **Enables build-time optimization**: When code is precomputed (e.g., via build-time processing),
  this function can immediately return `initialData`, avoiding async components entirely
- **Separates concerns**: Data validation is separate from data loading, making the codebase
  more predictable and easier to reason about

When `initialData: false` is returned, the calling component is responsible for initiating
asynchronous loading operations (e.g., `loadCodeFallback`, `CodeInitialSourceLoader`).

**Parameters:**

| Parameter         | Type       | Default | Description                                                                                                                                                                                                                                            |
| :---------------- | :--------- | :------ | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| variants          | `string[]` | -       | Array of all available variant names for this code block (e.g., \['javascript', 'typescript'])                                                                                                                                                         |
| variant           | `string`   | -       | The specific variant we want to display (must exist in variants array)                                                                                                                                                                                 |
| code?             | `Code`     | -       | The code object containing all variant data (may be undefined if not loaded)                                                                                                                                                                           |
| fileName?         | `string`   | -       | Optional specific file to display. Resolution logic: When it matches `variantCode.fileName`, uses the main variant sourceWhen it doesn't match, looks for the file in `variantCode.extraFiles`When undefined, defaults to the main file of the variant |
| needsHighlight?   | `boolean`  | -       | Whether the code needs to be syntax highlighted (source must be highlighted object, not string)                                                                                                                                                        |
| needsAllFiles?    | `boolean`  | -       | Whether all extra files must be loaded before rendering (checks that all extraFiles have source content)                                                                                                                                               |
| needsAllVariants? | `boolean`  | -       | Whether all variants must be available before rendering (validates using hasAllVariants)                                                                                                                                                               |

**Return Value:**

Object with either:

- `initialData: false` with a `reason` string explaining why data is insufficient for rendering
- `initialData: object` containing the validated data ready for immediate rendering, including:
- `code`: The full code object
- `initialFilename`: The resolved filename (may be undefined if variant has no fileName)
- `initialSource`: The source content for the requested file
- `initialExtraFiles`: Extra files associated with the variant (if any)

| Property      | Type                                                                | Description |
| :------------ | :------------------------------------------------------------------ | :---------- |
| `initialData` | `false \| { code: Code; initialFilename: string \| undefined; i...` | -           |
| `reason`      | `string \| undefined`                                               | -           |

### mergeCodeMetadata

**Parameters:**

| Parameter      | Type                   | Default | Description |
| :------------- | :--------------------- | :------ | :---------- |
| variant        | `VariantCode`          | -       | -           |
| metadataFiles? | `VariantExtraFiles`    | -       | -           |
| options?       | `MergeMetadataOptions` | -       | -           |

**Return Value:**

```tsx
type ReturnValue = VariantCode;
```

### parseCode

Pure function to parse code variants and their extraFiles.
Converts string sources to HAST nodes and handles hastJson parsing.

**Parameters:**

| Parameter   | Type          | Default | Description |
| :---------- | :------------ | :------ | :---------- |
| code        | `Code`        | -       | -           |
| parseSource | `ParseSource` | -       | -           |

**Return Value:**

```tsx
type ReturnValue = Code;
```

## Additional Types

### FallbackVariants

```typescript
type FallbackVariants = {
  code: Code;
  initialFilename: string | undefined;
  initialSource: VariantSource;
  initialExtraFiles?: VariantExtraFiles;
  allFileNames: string[];
  processedGlobalsCode?: Code[];
};
```

### FileWithPath

```typescript
type FileWithPath = { source?: VariantSource; metadata?: boolean; path: string };
```

### FlatFile

```typescript
type FlatFile = { source: string; metadata?: boolean };
```

### FlattenedFiles

```typescript
type FlattenedFiles = { [filePath: string]: FlatFile };
```

### PathContext

```typescript
type PathContext = PathContextWithUrl | PathContextWithoutUrl;
```

## External Types

### ParseSource

```typescript
type ParseSource = (
  source: string,
  fileName: string,
  language?: string | undefined,
) => { data?: unknown | undefined };
```

### SourceEnhancer

```typescript
type SourceEnhancer = (
  root: { data?: unknown | undefined },
  comments: {} | undefined,
  fileName: string,
) => { data?: unknown | undefined } | Promise;
```

### LoadSource

```typescript
type LoadSource = (url: string) => Promise;
```

### LoadVariantMeta

```typescript
type LoadVariantMeta = (variantName: string, url: string) => Promise;
```

### TransformSource

```typescript
type TransformSource = (source: string, fileName: string) => Promise;
```

### LoadCodeMeta

```typescript
type LoadCodeMeta = (url: string) => Promise;
```

# Sync Types

The core server-side function for synchronizing TypeScript type documentation. This function extracts types from your source code, updates the `types.md` file, and returns the latest formatted data for use in documentation pages.

---

## Overview

`syncTypes` is the core type synchronization function that:

- Loads TypeScript configuration
- Resolves library source files
- Finds meta files (DataAttributes, CssVars)
- Processes types via worker thread
- Formats component and hook types (as plain text)
- **Updates `types.md`** with the latest type documentation
- Returns the formatted data for rendering

This function is separated from the webpack loader to allow reuse in other contexts (e.g., API routes, scripts, or custom build tools).

> **Note**: Type highlighting is handled separately by [`loadServerTypes`](../load-server-types/page.mdx), which calls this function and then applies `highlightTypes` and `enhanceCodeTypes` to convert plain text types to syntax-highlighted HAST.

---

## Usage

### Basic Usage

```typescript
import { syncTypes } from '@mui/internal-docs-infra/pipeline/syncTypes';

// Sync the types (updates types.md and returns latest data)
const result = await syncTypes({
  typesMarkdownPath: '/absolute/path/to/types.md',
  rootContext: '/absolute/path/to/project',
  variants: { Default: '@base-ui/react/checkbox' },
  // Optional: watchSourceDirectly
  formattingOptions: {
    shortTypeUnionPrintWidth: 40,
    defaultValueUnionPrintWidth: 40,
  },
});

// Use the results
console.log(result.exports); // Record<string, { type: TypesMeta; additionalTypes: TypesMeta[] }>
console.log(result.additionalTypes); // TypesMeta[] for top-level types
console.log(result.allDependencies); // string[] - files to watch
```

### With Custom Socket Directory

```typescript
const result = await syncTypes({
  typesMarkdownPath: '/absolute/path/to/types.md',
  rootContext: '/absolute/path/to/project',
  variants: { Default: '@base-ui/react/checkbox' },
  socketDir: '/tmp/my-custom-socket-dir', // For Windows compatibility
  performanceLogging: true,
});
```

---

## Options

### SyncTypesOptions

```typescript
interface SyncTypesOptions {
  /** Absolute path to the types.md file to generate */
  typesMarkdownPath: string;

  /** Root context directory (workspace root) */
  rootContext: string;

  /**
   * Map of variant name to file path (relative or package path).
   * For single component: { Default: './Component' }
   * For multiple: { CssModules: './css-modules/Component', Tailwind: './tailwind/Component' }
   */
  variants?: Record<string, string>;

  /**
   * When true, resolves library paths to their source files for watching.
   * Useful during development to watch the original source rather than built files.
   */
  watchSourceDirectly?: boolean;

  /** Options for formatting types in tables */
  formattingOptions?: FormatInlineTypeOptions;

  /**
   * Directory path for socket and lock files used for IPC between workers.
   * Useful for Windows where the default temp directory may not support Unix domain sockets.
   */
  socketDir?: string;

  /** Enable performance logging */
  performanceLogging?: boolean;

  /**
   * Options for updating the parent index page with component metadata.
   * When provided, calls syncPageIndex to update the parent directory's page.mdx
   * with props, dataAttributes, cssVariables, and parameters extracted from
   * component and hook types.
   */
  updateParentIndex?: {
    /** Base directory to stop recursion at when updating parent indexes */
    baseDir?: string;
    /** Name of the index file to update. @default 'page.mdx' */
    indexFileName?: string;
    /** Only update existing indexes, don't create new ones. @default false */
    onlyUpdateIndexes?: boolean;
    /** Directory to write marker files when indexes are updated */
    markerDir?: string;
    /** Throw an error if the index is out of date or missing */
    errorIfOutOfDate?: boolean;
  };
}
```

> **Note**: The `resourceName` (for display in markdown) and `relativePath` (for logging) are derived automatically from `typesMarkdownPath` and `rootContext`.

---

## Result

```typescript
interface SyncTypesResult {
  /** Variant data with plain text type fields (not yet highlighted) */
  variantData: Record<string, { types: TypesMeta[]; typeNameMap?: Record<string, string> }>;

  /** All dependencies that should be watched for changes */
  allDependencies: string[];

  /** All processed types for external use */
  allTypes: TypesMeta[];

  /** Type name map from variant processing */
  typeNameMap?: Record<string, string>;

  /** Whether the types.md file was updated (false if unchanged) */
  updated: boolean;
}
```

> **Note**: The `variantData` contains plain text type fields (`typeText`, `defaultText`). Use [`loadServerTypes`](../load-server-types/page.mdx) if you need `EnhancedTypesMeta` with syntax-highlighted HAST fields (`type`, `shortType`, `detailedType`, `default`).

---

## TypesMeta Structure

The function returns an array of `TypesMeta` objects, which can be one of three types:

### Component Type

```typescript
interface ComponentTypeMeta {
  type: 'component';
  name: string;
  data: {
    description?: HastRoot;
    props: Record<string, FormattedProperty>;
    dataAttributes: Record<string, FormattedProperty>;
    cssVariables: Record<string, FormattedProperty>;
  };
}

// FormattedProperty contains plain text type fields
interface FormattedProperty {
  typeText: string; // Plain text type (e.g., "string | number")
  defaultText?: string; // Plain text default value
  description?: HastRoot; // Markdown description (already HAST)
  example?: HastRoot; // Markdown example (already HAST)
  required?: boolean;
}
```

### Hook Type

```typescript
interface HookTypeMeta {
  type: 'hook';
  name: string;
  data: {
    description?: HastRoot;
    parameters: Record<string, FormattedParameter>;
    returnValue?: HastRoot | Record<string, FormattedProperty>;
  };
}

// FormattedParameter is similar to FormattedProperty
interface FormattedParameter {
  typeText: string; // Plain text type
  defaultText?: string; // Plain text default value
  description?: HastRoot; // Markdown description (already HAST)
  example?: HastRoot; // Markdown example (already HAST)
  required?: boolean;
}
```

### Raw Type (interfaces, type aliases, enums)

```typescript
interface RawTypeMeta {
  /** Display name for this type (may include dots like "Component.Root.State") */
  name: string;
  /** Description parsed from JSDoc as HAST */
  description?: HastRoot;
  /** Plain text version of description for markdown generation */
  descriptionText?: string;
  /**
   * The formatted type declaration as plain text (e.g., "type ButtonProps = { ... }").
   * Will be highlighted to HAST in loadServerTypes.
   */
  formattedCode: string;
  /**
   * For enum types, the individual members with their values and descriptions.
   * When present, indicates this type should be rendered as an enum table.
   */
  enumMembers?: EnumMemberMeta[];
  /**
   * For re-exports, the component name this type re-exports props from.
   * When set, indicates this should be rendered as a link to the component.
   */
  reExportOf?: string;
  /**
   * For DataAttributes types, the component name this type belongs to.
   */
  dataAttributesOf?: string;
  /**
   * For CssVars types, the component name this type belongs to.
   */
  cssVarsOf?: string;
}
```

---

## Processing Pipeline

### 1. Load TypeScript Configuration

Loads and caches `tsconfig.json` from the root context:

```typescript
const config = await loadTypescriptConfig(path.join(rootContext, 'tsconfig.json'));
```

### 2. Resolve Library Source Files

Resolves variant paths through tsconfig paths, handling:

- Relative paths
- Path aliases (e.g., `@base-ui/react/*`)
- External libraries with source maps

### 3. Find Meta Files

Automatically discovers `DataAttributes.ts` and `CssVars.ts` files:

```typescript
const metaFiles = await findMetaFiles(componentDirectory);
// Returns: ['CheckboxDataAttributes.ts', 'CheckboxCssVars.ts']
```

### 4. Process Types in Worker

Sends type extraction work to a dedicated worker thread:

```typescript
const workerResult = await workerManager.processTypes({
  projectPath: config.projectPath,
  compilerOptions: config.options,
  allEntrypoints,
  resolvedVariantMap,
});
```

### 5. Format Component and Hook Types

Converts raw TypeScript exports to formatted HAST structures:

```typescript
const formattedData = await formatComponentData(exportNode, allTypes, namespaces, typeNameMap, {
  formatting: formattingOptions,
});
```

### 6. Sync Types Markdown

Updates the `types.md` file alongside the `types.ts` file with the latest documentation:

```typescript
const markdown = await generateTypesMarkdown(resourceName, allTypes, typeNameMap);
await writeFile(markdownFilePath, markdown);
```

---

## Worker Architecture

The function uses a worker-based architecture for efficient TypeScript processing:

### Main Thread Responsibilities

- Loading TypeScript configuration
- Path resolution
- Formatting types to HAST
- Generating markdown
- Coordinating worker communication

### Worker Thread Responsibilities

- Creating/caching TypeScript program
- Parsing exports with `typescript-api-extractor`
- Managing file cache
- Tracking dependencies

### Socket-Based IPC

For multi-process environments (Next.js with multiple workers):

- First worker becomes the "server" and holds the TypeScript language service
- Other workers connect as "clients" via Unix socket
- All workers share a single TypeScript program instance

---

## Performance

### First Request

~500-1200ms to create TypeScript program and parse types

### Subsequent Requests

~100-140ms using cached program and file data

### Multi-Process Improvement

87-92% performance improvement vs. creating separate language services per process

---

## Related

- [`loadServerTypes`](../load-server-types/page.mdx) - Server-side function that calls this and applies highlighting
- [`loadPrecomputedTypesMeta`](../load-precomputed-types-meta/page.mdx) - Webpack loader that uses this function
- [`abstractCreateTypes`](../../factories/abstract-create-types/page.mdx) - Create type documentation factories
- [`typescript-api-extractor`](https://github.com/michaldudak/typescript-api-extractor) - Underlying type extraction library

---

## Types

import { TypesSyncTypes } from './types';

<TypesSyncTypes />

[See Types](./types.md#synctypes)

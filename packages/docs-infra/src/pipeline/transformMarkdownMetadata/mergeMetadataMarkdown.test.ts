import { describe, it, expect } from 'vitest';
import { mergeMetadataMarkdown } from './mergeMetadataMarkdown';
import type { PagesMetadata } from './metadataToMarkdown';

describe('mergeMetadataMarkdown', () => {
  it('should create new markdown when no existing markdown is provided', async () => {
    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'A button component.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(undefined, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button](#button) - [Full Docs](./button/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button

      A button component.

      [Read more](./button/page.mdx)
      "
    `);
  });

  it('should preserve order from existing markdown', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Checkbox](./checkbox/page.mdx) - A checkbox.
- [Button](./button/page.mdx) - A button.

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'Updated button description.',
        },
        {
          slug: 'checkbox',
          path: './checkbox/page.mdx',
          title: 'Checkbox',
          description: 'Updated checkbox description.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button](#button) - [Full Docs](./button/page.mdx)
      - [Checkbox](#checkbox) - [Full Docs](./checkbox/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button

      Updated button description.

      [Read more](./button/page.mdx)

      ## Checkbox

      Updated checkbox description.

      [Read more](./checkbox/page.mdx)
      "
    `);
  });

  it('should add new pages at the end while preserving existing order', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Button](./button/page.mdx) - A button.
- [Checkbox](./checkbox/page.mdx) - A checkbox.

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'A button component.',
        },
        {
          slug: 'checkbox',
          path: './checkbox/page.mdx',
          title: 'Checkbox',
          description: 'A checkbox component.',
        },
        {
          slug: 'input',
          path: './input/page.mdx',
          title: 'Input',
          description: 'An input component.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button](#button) - [Full Docs](./button/page.mdx)
      - [Checkbox](#checkbox) - [Full Docs](./checkbox/page.mdx)
      - [Input](#input) - [Full Docs](./input/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button

      A button component.

      [Read more](./button/page.mdx)

      ## Checkbox

      A checkbox component.

      [Read more](./checkbox/page.mdx)

      ## Input

      An input component.

      [Read more](./input/page.mdx)
      "
    `);
  });

  it('should remove pages that are not in new metadata', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Button](./button/page.mdx) - A button.
- [Checkbox](./checkbox/page.mdx) - A checkbox.
- [Input](./input/page.mdx) - An input.

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'A button component.',
        },
        {
          slug: 'checkbox',
          path: './checkbox/page.mdx',
          title: 'Checkbox',
          description: 'A checkbox component.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button](#button) - [Full Docs](./button/page.mdx)
      - [Checkbox](#checkbox) - [Full Docs](./checkbox/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button

      A button component.

      [Read more](./button/page.mdx)

      ## Checkbox

      A checkbox component.

      [Read more](./checkbox/page.mdx)
      "
    `);
  });

  it('should update title from new metadata', async () => {
    const existingMarkdown = `# Old Title

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Button](./button/page.mdx) - A button.

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'
`;

    const newMetadata: PagesMetadata = {
      title: 'New Title',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'A button component.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# New Title

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button](#button) - [Full Docs](./button/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button

      A button component.

      [Read more](./button/page.mdx)
      "
    `);
  });

  it('should handle malformed markdown by using new metadata only', async () => {
    const existingMarkdown = `This is not valid markdown`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'A button component.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button](#button) - [Full Docs](./button/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button

      A button component.

      [Read more](./button/page.mdx)
      "
    `);
  });

  it('should update all metadata fields while preserving order', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Button](./button/page.mdx) - Old description.

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

## Button

Old description.

[Read more](./button/page.mdx)
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'New description with more details.',
          keywords: ['interactive', 'input'],
          openGraph: {
            title: 'Button Component',
            description: 'A comprehensive button component.',
            images: [
              {
                url: 'https://example.com/button.png',
                width: 800,
                height: 600,
                alt: 'Button preview',
              },
            ],
          },
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button Component](#button) - [Full Docs](./button/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button Component

      A comprehensive button component.

      ![Button preview](https://example.com/button.png)

      - Keywords: interactive, input

      [Read more](./button/page.mdx)
      "
    `);
  });

  it('should handle empty existing pages array', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'A button component.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button](#button) - [Full Docs](./button/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button

      A button component.

      [Read more](./button/page.mdx)
      "
    `);
  });

  it('should handle complex reordering scenario', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Zebra](./zebra/page.mdx) - Z component.
- [Alpha](./alpha/page.mdx) - A component.
- [Middle](./middle/page.mdx) - M component.

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        // Pages in alphabetical order (different from existing)
        {
          slug: 'alpha',
          path: './alpha/page.mdx',
          title: 'Alpha',
          description: 'Updated A.',
        },
        {
          slug: 'beta',
          path: './beta/page.mdx',
          title: 'Beta',
          description: 'New B.',
        },
        {
          slug: 'middle',
          path: './middle/page.mdx',
          title: 'Middle',
          description: 'Updated M.',
        },
        {
          slug: 'zebra',
          path: './zebra/page.mdx',
          title: 'Zebra',
          description: 'Updated Z.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Alpha](#alpha) - [Full Docs](./alpha/page.mdx)
      - [Beta](#beta) - [Full Docs](./beta/page.mdx)
      - [Middle](#middle) - [Full Docs](./middle/page.mdx)
      - [Zebra](#zebra) - [Full Docs](./zebra/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Alpha

      Updated A.

      [Read more](./alpha/page.mdx)

      ## Beta

      New B.

      [Read more](./beta/page.mdx)

      ## Middle

      Updated M.

      [Read more](./middle/page.mdx)

      ## Zebra

      Updated Z.

      [Read more](./zebra/page.mdx)
      "
    `);
  });

  it('should fix inconsistent ordering in input markdown', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Checkbox](./checkbox/page.mdx) - A checkbox.
- [Button](./button/page.mdx) - A button.
- [Input](./input/page.mdx) - An input.

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

## Button

Old button description.

[Read more](./button/page.mdx)

## Input

Old input description.

[Read more](./input/page.mdx)

## Checkbox

Old checkbox description.

[Read more](./checkbox/page.mdx)
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'Updated button.',
        },
        {
          slug: 'checkbox',
          path: './checkbox/page.mdx',
          title: 'Checkbox',
          description: 'Updated checkbox.',
        },
        {
          slug: 'input',
          path: './input/page.mdx',
          title: 'Input',
          description: 'Updated input.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button](#button) - [Full Docs](./button/page.mdx)
      - [Checkbox](#checkbox) - [Full Docs](./checkbox/page.mdx)
      - [Input](#input) - [Full Docs](./input/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button

      Updated button.

      [Read more](./button/page.mdx)

      ## Checkbox

      Updated checkbox.

      [Read more](./checkbox/page.mdx)

      ## Input

      Updated input.

      [Read more](./input/page.mdx)
      "
    `);
  });
});

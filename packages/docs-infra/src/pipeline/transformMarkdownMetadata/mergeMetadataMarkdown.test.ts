import { describe, it, expect } from 'vitest';
import { mergeMetadataMarkdown } from './mergeMetadataMarkdown';
import type { PagesMetadata } from './metadataToMarkdown';

describe('mergeMetadataMarkdown', () => {
  it('should create new markdown when no existing markdown is provided', async () => {
    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'A button component.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(undefined, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button](#button) - [Full Docs](./button/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button

      A button component.

      [Read more](./button/page.mdx)
      "
    `);
  });

  it('should preserve order from existing markdown', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Checkbox](#checkbox) - [Full Docs](./checkbox/page.mdx)
- [Button](#button) - [Full Docs](./button/page.mdx)

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

## Checkbox

Old checkbox description.

[Read more](./checkbox/page.mdx)

## Button

Old button description.

[Read more](./button/page.mdx)
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'Updated button description.',
        },
        {
          slug: 'checkbox',
          path: './checkbox/page.mdx',
          title: 'Checkbox',
          description: 'Updated checkbox description.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Checkbox](#checkbox) - [Full Docs](./checkbox/page.mdx)
      - [Button](#button) - [Full Docs](./button/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Checkbox

      Updated checkbox description.

      [Read more](./checkbox/page.mdx)

      ## Button

      Updated button description.

      [Read more](./button/page.mdx)
      "
    `);
  });

  it('should add new pages at the end while preserving existing order', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Button](#button) - [Full Docs](./button/page.mdx)
- [Checkbox](#checkbox) - [Full Docs](./checkbox/page.mdx)

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

## Button

Old button description.

[Read more](./button/page.mdx)

## Checkbox

Old checkbox description.

[Read more](./checkbox/page.mdx)
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'A button component.',
        },
        {
          slug: 'checkbox',
          path: './checkbox/page.mdx',
          title: 'Checkbox',
          description: 'A checkbox component.',
        },
        {
          slug: 'input',
          path: './input/page.mdx',
          title: 'Input',
          description: 'An input component.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button](#button) - [Full Docs](./button/page.mdx)
      - [Checkbox](#checkbox) - [Full Docs](./checkbox/page.mdx)
      - [Input](#input) - [Full Docs](./input/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button

      A button component.

      [Read more](./button/page.mdx)

      ## Checkbox

      A checkbox component.

      [Read more](./checkbox/page.mdx)

      ## Input

      An input component.

      [Read more](./input/page.mdx)
      "
    `);
  });

  it('should remove pages that are not in new metadata', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Button](#button) - [Full Docs](./button/page.mdx)
- [Checkbox](#checkbox) - [Full Docs](./checkbox/page.mdx)
- [Input](#input) - [Full Docs](./input/page.mdx)

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

## Button

Old button description.

[Read more](./button/page.mdx)

## Checkbox

Old checkbox description.

[Read more](./checkbox/page.mdx)

## Input

Old input description.

[Read more](./input/page.mdx)
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'A button component.',
        },
        {
          slug: 'checkbox',
          path: './checkbox/page.mdx',
          title: 'Checkbox',
          description: 'A checkbox component.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button](#button) - [Full Docs](./button/page.mdx)
      - [Checkbox](#checkbox) - [Full Docs](./checkbox/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button

      A button component.

      [Read more](./button/page.mdx)

      ## Checkbox

      A checkbox component.

      [Read more](./checkbox/page.mdx)
      "
    `);
  });

  it('should update title from new metadata', async () => {
    const existingMarkdown = `# Old Title

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Button](#button) - [Full Docs](./button/page.mdx)

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

## Button

Old button description.

[Read more](./button/page.mdx)
`;

    const newMetadata: PagesMetadata = {
      title: 'New Title',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'A button component.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# New Title

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button](#button) - [Full Docs](./button/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button

      A button component.

      [Read more](./button/page.mdx)
      "
    `);
  });

  it('should handle malformed markdown by using new metadata only', async () => {
    const existingMarkdown = `This is not valid markdown`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'A button component.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button](#button) - [Full Docs](./button/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button

      A button component.

      [Read more](./button/page.mdx)
      "
    `);
  });

  it('should update all metadata fields while preserving order', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Button](#button) - [Full Docs](./button/page.mdx)

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

## Button

Old description.

[Read more](./button/page.mdx)
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'New description with more details.',
          keywords: ['interactive', 'input'],
          openGraph: {
            title: 'Button Component',
            description: 'A comprehensive button component.',
            images: [
              {
                url: 'https://example.com/button.png',
                width: 800,
                height: 600,
                alt: 'Button preview',
              },
            ],
          },
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button Component](#button) - [Full Docs](./button/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button Component

      A comprehensive button component.

      ![Button preview](https://example.com/button.png)

      - Keywords: interactive, input

      [Read more](./button/page.mdx)
      "
    `);
  });

  it('should handle empty existing pages array', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'A button component.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Button](#button) - [Full Docs](./button/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Button

      A button component.

      [Read more](./button/page.mdx)
      "
    `);
  });

  it('should handle complex reordering scenario', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Zebra](#zebra) - [Full Docs](./zebra/page.mdx)
- [Alpha](#alpha) - [Full Docs](./alpha/page.mdx)
- [Middle](#middle) - [Full Docs](./middle/page.mdx)

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

## Zebra

Old Z description.

[Read more](./zebra/page.mdx)

## Alpha

Old A description.

[Read more](./alpha/page.mdx)

## Middle

Old M description.

[Read more](./middle/page.mdx)
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        // Pages in alphabetical order (different from existing)
        {
          slug: 'alpha',
          path: './alpha/page.mdx',
          title: 'Alpha',
          description: 'Updated A.',
        },
        {
          slug: 'beta',
          path: './beta/page.mdx',
          title: 'Beta',
          description: 'New B.',
        },
        {
          slug: 'middle',
          path: './middle/page.mdx',
          title: 'Middle',
          description: 'Updated M.',
        },
        {
          slug: 'zebra',
          path: './zebra/page.mdx',
          title: 'Zebra',
          description: 'Updated Z.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Zebra](#zebra) - [Full Docs](./zebra/page.mdx)
      - [Alpha](#alpha) - [Full Docs](./alpha/page.mdx)
      - [Middle](#middle) - [Full Docs](./middle/page.mdx)
      - [Beta](#beta) - [Full Docs](./beta/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Zebra

      Updated Z.

      [Read more](./zebra/page.mdx)

      ## Alpha

      Updated A.

      [Read more](./alpha/page.mdx)

      ## Middle

      Updated M.

      [Read more](./middle/page.mdx)

      ## Beta

      New B.

      [Read more](./beta/page.mdx)
      "
    `);
  });

  it('should fix inconsistent ordering in input markdown', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Checkbox](#checkbox) - [Full Docs](./checkbox/page.mdx)
- [Button](#button) - [Full Docs](./button/page.mdx)
- [Input](#input) - [Full Docs](./input/page.mdx)

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

## Button

Old button description.

[Read more](./button/page.mdx)

## Input

Old input description.

[Read more](./input/page.mdx)

## Checkbox

Old checkbox description.

[Read more](./checkbox/page.mdx)
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'button',
          path: './button/page.mdx',
          title: 'Button',
          description: 'Updated button.',
        },
        {
          slug: 'checkbox',
          path: './checkbox/page.mdx',
          title: 'Checkbox',
          description: 'Updated checkbox.',
        },
        {
          slug: 'input',
          path: './input/page.mdx',
          title: 'Input',
          description: 'Updated input.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Checkbox](#checkbox) - [Full Docs](./checkbox/page.mdx)
      - [Button](#button) - [Full Docs](./button/page.mdx)
      - [Input](#input) - [Full Docs](./input/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Checkbox

      Updated checkbox.

      [Read more](./checkbox/page.mdx)

      ## Button

      Updated button.

      [Read more](./button/page.mdx)

      ## Input

      Updated input.

      [Read more](./input/page.mdx)
      "
    `);
  });

  it('should handle metadata with parts, props, dataAttributes, and cssVariables', async () => {
    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'tooltip',
          path: './tooltip/page.mdx',
          title: 'Tooltip',
          description: 'A tooltip component.',
          parts: ['Root', 'Trigger', 'Popup', 'Portal'],
          props: ['align', 'className', 'defaultOpen', 'open', 'side'],
          dataAttributes: ['data-align', 'data-open', 'data-side'],
          cssVariables: ['--anchor-height', '--anchor-width', '--transform-origin'],
        },
      ],
    };

    const result = await mergeMetadataMarkdown(undefined, newMetadata);

    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Tooltip](#tooltip) - [Full Docs](./tooltip/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Tooltip

      A tooltip component.

      - Parts: Root, Trigger, Popup, Portal
      - Props: align, className, defaultOpen, open, side
      - Data Attributes: data-align, data-open, data-side
      - CSS Variables: --anchor-height, --anchor-width, --transform-origin

      [Read more](./tooltip/page.mdx)
      "
    `);
  });

  it('should round-trip parse metadata with all new fields', async () => {
    const originalMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'alert-dialog',
          path: './alert-dialog/page.mdx',
          title: 'Alert Dialog',
          description: 'An alert dialog component.',
          parts: ['Root', 'Trigger', 'Popup', 'Backdrop'],
          props: ['className', 'defaultOpen', 'modal', 'onOpenChange', 'open'],
          dataAttributes: ['data-open', 'data-closed'],
          cssVariables: ['--popup-height', '--popup-width'],
        },
      ],
    };

    const markdown = await mergeMetadataMarkdown(undefined, originalMetadata);

    // Now parse it back
    const { markdownToMetadata } = await import('./metadataToMarkdown');
    const parsedMetadata = await markdownToMetadata(markdown);

    expect(parsedMetadata).not.toBeNull();
    expect(parsedMetadata?.title).toBe('Components');
    expect(parsedMetadata?.pages).toHaveLength(1);

    const page = parsedMetadata?.pages[0];
    expect(page?.slug).toBe('alert-dialog');
    expect(page?.title).toBe('Alert Dialog');
    expect(page?.description).toBe('An alert dialog component.');
    expect(page?.parts).toEqual(['Root', 'Trigger', 'Popup', 'Backdrop']);
    expect(page?.props).toEqual(['className', 'defaultOpen', 'modal', 'onOpenChange', 'open']);
    expect(page?.dataAttributes).toEqual(['data-open', 'data-closed']);
    expect(page?.cssVariables).toEqual(['--popup-height', '--popup-width']);
  });

  it('should update existing page when title changes instead of creating duplicate', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Old Button Name](#old-button-name) - [Full Docs](./button/page.mdx)
- [Checkbox](#checkbox) - [Full Docs](./checkbox/page.mdx)

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

## Old Button Name

Old description of the button.

[Read more](./button/page.mdx)

## Checkbox

A checkbox component.

[Read more](./checkbox/page.mdx)
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'new-button-name',
          path: './button/page.mdx',
          title: 'New Button Name',
          description: 'Updated description of the button.',
        },
        {
          slug: 'checkbox',
          path: './checkbox/page.mdx',
          title: 'Checkbox',
          description: 'A checkbox component.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    // Should update the existing entry's title in both TOC and content section,
    // and use the NEW description from the metadata (not preserve the old one)
    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [New Button Name](#new-button-name) - [Full Docs](./button/page.mdx)
      - [Checkbox](#checkbox) - [Full Docs](./checkbox/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## New Button Name

      Updated description of the button.

      [Read more](./button/page.mdx)

      ## Checkbox

      A checkbox component.

      [Read more](./checkbox/page.mdx)
      "
    `);
  });

  it('should preserve order when file has no alphabetical sorting marker', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following order can be modified'

- [Zebra](#zebra) - [Full Docs](./zebra/page.mdx)
- [Alpha](#alpha) - [Full Docs](./alpha/page.mdx)

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

## Zebra

Z component.

[Read more](./zebra/page.mdx)

## Alpha

A component.

[Read more](./alpha/page.mdx)
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'zebra',
          path: './zebra/page.mdx',
          title: 'Zebra',
          description: 'Z component.',
        },
        {
          slug: 'alpha',
          path: './alpha/page.mdx',
          title: 'Alpha',
          description: 'A component.',
        },
        {
          slug: 'middle',
          path: './middle/page.mdx',
          title: 'Middle',
          description: 'M component.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    // Should preserve Zebra, Alpha order and add Middle at the end
    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Zebra](#zebra) - [Full Docs](./zebra/page.mdx)
      - [Alpha](#alpha) - [Full Docs](./alpha/page.mdx)
      - [Middle](#middle) - [Full Docs](./middle/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Zebra

      Z component.

      [Read more](./zebra/page.mdx)

      ## Alpha

      A component.

      [Read more](./alpha/page.mdx)

      ## Middle

      M component.

      [Read more](./middle/page.mdx)
      "
    `);
  });

  it('should sort pages alphabetically when file requests alphabetical sorting', async () => {
    const existingMarkdown = `# Components

[//]: # 'This file is autogenerated, but the following list can be modified. Automatically sorted alphabetically.'

- [Zebra](#zebra) - [Full Docs](./zebra/page.mdx)
- [Alpha](#alpha) - [Full Docs](./alpha/page.mdx)

[//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

## Zebra

Z component.

[Read more](./zebra/page.mdx)

## Alpha

A component.

[Read more](./alpha/page.mdx)
`;

    const newMetadata: PagesMetadata = {
      title: 'Components',
      pages: [
        {
          slug: 'zebra',
          path: './zebra/page.mdx',
          title: 'Zebra',
          description: 'Z component.',
        },
        {
          slug: 'alpha',
          path: './alpha/page.mdx',
          title: 'Alpha',
          description: 'A component.',
        },
        {
          slug: 'middle',
          path: './middle/page.mdx',
          title: 'Middle',
          description: 'M component.',
        },
      ],
    };

    const result = await mergeMetadataMarkdown(existingMarkdown, newMetadata);

    // Should sort alphabetically with explicit marker preserved
    expect(result).toMatchInlineSnapshot(`
      "# Components

      [//]: # 'This file is autogenerated, but the following order can be modified'

      - [Alpha](#alpha) - [Full Docs](./alpha/page.mdx)
      - [Middle](#middle) - [Full Docs](./middle/page.mdx)
      - [Zebra](#zebra) - [Full Docs](./zebra/page.mdx)

      [//]: # 'This file is autogenerated, DO NOT EDIT AFTER THIS LINE'

      ## Alpha

      A component.

      [Read more](./alpha/page.mdx)

      ## Middle

      M component.

      [Read more](./middle/page.mdx)

      ## Zebra

      Z component.

      [Read more](./zebra/page.mdx)
      "
    `);
  });
});

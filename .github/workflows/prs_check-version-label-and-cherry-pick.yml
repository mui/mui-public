name: Check PR for version labels and cherry-pick

on:
  workflow_call:
    inputs:
      main_version_label:
        description: "The main version label for the default branch (e.g. `v9.x`)"
        required: true
        type: string
    secrets:
      token:
        # Needed when the repository uses GitHub actions https://github.com/orgs/community/discussions/55906
        # We usually use CircleCI but not always.
        description: "The github token to use for the API calls. You can use the GITHUB_TOKEN secret"
        required: false

permissions: {}

jobs:
  check_version_label:
    runs-on: ubuntu-latest
    name: Check PR version labels
    permissions:
      pull-requests: read
    if: ${{ github.event.pull_request.merged == false }}
    outputs:
      needsCherryPick: ${{ steps.check.outputs.NEEDS_CHERRY_PICK }}
      cherryPickTargets: ${{ steps.check.outputs.CHERRY_PICK_TARGETS }}
    steps:
      - name: Check version labels
        id: check
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const vLabelRegex = /^v\d+\.x$/;
            const NO_VERSION_LABEL_COMMENT =
              'Please add a version label to categorize which major version this PR targets:';

            const mainVersionLabel = '${{ inputs.main_version_label }}';

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pullNumber = context.issue.number;

            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: pullNumber,
            });

            core.info(`>>> PR fetched: ${pr.number}`);
            core.info(`>>> PR base branch: ${pr.base.ref}`);
            core.info(`>>> Main version label configured: ${mainVersionLabel}`);

            const versionLabels = pr.labels
              ?.map((label) => label.name)
              .filter((labelName) => vLabelRegex.test(labelName));

            if (versionLabels.length === 0) {
              core.info(`>>> No version labels found`);
              const exampleLabels = mainVersionLabel
                ? [mainVersionLabel, 'v8.x', 'v7.x']
                : ['v8.x', 'v7.x'];
              // Dedupe in case mainVersionLabel is one of the examples
              const uniqueExamples = [...new Set(exampleLabels)];
              core.setFailed(`>>> ${NO_VERSION_LABEL_COMMENT} ${uniqueExamples.join(', ')}`);
              return;
            }

            core.info(`>>> Version labels found: ${versionLabels.join(', ')}`);

            // Determine if we need to trigger cherry-pick
            // Cherry-pick is needed when:
            // 1. PR is targeting the default branch and has version labels OTHER than the main version label
            // 2. PR is targeting a version branch and has version labels OTHER than that branch's label
            const defaultBranch = context.payload.repository?.default_branch || 'master';
            const baseBranch = pr.base.ref;
            const isOnDefaultBranch = baseBranch === defaultBranch;
            const isOnVersionBranch = vLabelRegex.test(baseBranch);

            core.info(`>>> Base branch: ${baseBranch}`);
            core.info(`>>> Is on default branch: ${isOnDefaultBranch}`);
            core.info(`>>> Is on version branch: ${isOnVersionBranch}`);

            // Determine the "current" version label for this branch
            // - If on default branch, it's the mainVersionLabel
            // - If on a version branch (e.g., v8.x), it's the branch name itself
            let currentBranchLabel = '';
            if (isOnDefaultBranch) {
              currentBranchLabel = mainVersionLabel;
            } else if (isOnVersionBranch) {
              currentBranchLabel = baseBranch;
            }

            core.info(`>>> Current branch label: ${currentBranchLabel || '(none)'}`);

            if (currentBranchLabel) {
              // Filter out the current branch's label to find cherry-pick targets
              const cherryPickTargets = versionLabels.filter((label) => label !== currentBranchLabel);

              if (cherryPickTargets.length > 0) {
                core.info(`>>> PR has version labels for other branches`);
                core.info(`>>> Cherry-pick targets: ${cherryPickTargets.join(', ')}`);
                core.setOutput('NEEDS_CHERRY_PICK', 'true');
                core.setOutput('CHERRY_PICK_TARGETS', JSON.stringify(cherryPickTargets));
              } else {
                core.info(`>>> PR only has the current branch's version label, no cherry-pick needed`);
                core.setOutput('NEEDS_CHERRY_PICK', 'false');
                core.setOutput('CHERRY_PICK_TARGETS', '[]');
              }
            } else {
              core.info(
                `>>> PR is not on default branch or a version branch, no cherry-pick logic applies`,
              );
              core.setOutput('NEEDS_CHERRY_PICK', 'false');
              core.setOutput('CHERRY_PICK_TARGETS', '[]');
            }

            core.info(`>>> Version label check passed`);

  open_cherry_pick_pr:
    runs-on: ubuntu-latest
    name: Open cherry-pick PR with target branch
    needs: check_version_label
    if: ${{ needs.check_version_label.outputs.needsCherryPick == 'true' && github.event.pull_request.merged == true }}
    strategy:
      matrix:
        branch: ${{ fromJSON(needs.check_version_label.outputs.cherryPickTargets) }}
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
      - name: Cherry pick and create the new PR
        uses: carloscastrojumo/github-cherry-pick-action@503773289f4a459069c832dc628826685b75b4b3 # v1.0.10
        with:
          branch: ${{ matrix.branch }}
          token: ${{ secrets.token || secrets.GITHUB_TOKEN }}
          body: "Cherry-pick of #{old_pull_request_id}"
          cherry-pick-branch: ${{ format('cherry-pick-{0}-to-{1}', github.event.number, matrix.branch) }}
          title: "{old_title} (@${{ github.event.pull_request.user.login }})"
          inherit_labels: false
          labels: "${{ github.event.repository.default_branch == matrix.branch && inputs.main_version_label || matrix.branch }},cherry-pick"
